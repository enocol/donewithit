{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container py-4 bg-light rounded-3 ">
  <h1 class="h4 mb-3">Edit: {{ product.product_name }}</h1>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
  {% endif %}

  <form method="post" enctype="multipart/form-data" class=" p-3 shadow-sm">
    {% csrf_token %}

    <!-- Product fields -->
<div class="row g-3">
  {% for field in form %}
    <div class="row mb-3 align-items-center">
      <label class="col-sm-3 col-form-label" for="{{ field.id_for_label }}">
        {{ field.label }}
      </label>
      <div class="col-sm-9">
         {% if field.name == "main_image" and form.instance.main_image %}
        <div class="mt-2">
          <img src="{{ form.instance.main_image.url }}" 
               alt="Current image" 
               class="img-thumbnail" 
               style="max-height: 120px;">
        </div>
      {% endif %}
      {# Show category display name if editing an existing product #}
      {% if field.name == "category" %}
        <div class="mt-2">
          {{ form.instance.category.get_display_name }}
        </div>
      {% endif %}

       {{ field }}   

        {% if field.help_text %}
          <div class="form-text">{{ field.help_text }}</div>
        {% endif %}

        {% for error in field.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>
    </div>
  {% endfor %}
</div>


    <hr class="my-4"/>

    <!-- Related images -->
    <h2 class="h5">Additional Images</h2>
    {{ formset.management_form }}
    <div id="images-formset" class="row g-3">
      {% for f in formset.forms %}
        <div class="col-md-6">
          <div class="border rounded p-3 h-100">
            {# Include hidden fields like id/product so existing forms validate #}
            {% for hidden in f.hidden_fields %}
              {{ hidden }}
            {% endfor %}

            {{ f.non_field_errors }}

            {% if f.instance.pk and f.instance.image %}
              <img class="thumb mb-2" src="{{ f.instance.image.url }}" alt="Image" style="max-width: 100px; height: auto;"/>
            {% endif %}

            <div class="mb-2">
              <label class="form-label" for="{{ f.image.id_for_label }}">Image</label>
              {{ f.image }}
              {% for error in f.image.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
            </div>

            {% if formset.can_delete %}
              <div class="form-check">
                {{ f.DELETE }}
                <label class="form-check-label" for="{{ f.DELETE.id_for_label }}">Delete this image</label>
              </div>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>

    <!-- Add-another (JS uses empty_form) -->
    <template id="empty-form">
      <div class="col-md-6">
        <div class="border rounded p-3 h-100">
          <div class="mb-2">
            <label class="form-label">Image</label>
            {{ formset.empty_form.image }}
          </div>
        </div>
      </div>
    </template>

    <div class="d-flex justify-content-between mt-4">
      <button type="button" id="add-image" class="btn btn-outline-primary">Add another image</button>
      <div>
        <a class="btn btn-light" href="{% url 'product_detail' product.pk %}">Cancel</a>
        <button type="submit" class="btn btn-primary">Save changes</button>
      </div>
    </div>
  </form>

  <script>
  (function(){
    const container = document.getElementById('images-formset');
    const addBtn = document.getElementById('add-image');
    const tmpl = document.getElementById('empty-form').content;
    const totalInput = document.querySelector('[name="{{ formset.prefix }}-TOTAL_FORMS"]');
    const maxInput = document.querySelector('[name="{{ formset.prefix }}-MAX_NUM_FORMS"]');

    addBtn.addEventListener('click', () => {
      const total = parseInt(totalInput.value, 10);
      const max = parseInt((maxInput && maxInput.value) || '1000', 10);
      if (total >= max) { alert('Maximum number of images reached.'); return; }

      const clone = document.importNode(tmpl, true);
      // Fix __prefix__ in new field names/ids
      clone.querySelectorAll('[name],[id],[for]').forEach(el => {
        ['name','id','for'].forEach(attr => {
          if (el.hasAttribute(attr)) {
            el.setAttribute(attr, el.getAttribute(attr).replace('__prefix__', '{{ formset.prefix }}-' + total));
          }
        });
      });

      container.appendChild(clone);
      totalInput.value = total + 1;
    });
  })();
  </script>
</div>
{% endblock %}
